<!DOCTYPE html>
<html>
<head>
  <title>BeautiFi WiFi Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 400px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 10px; color: #00d4ff; }
    .subtitle { text-align: center; color: #888; margin-bottom: 30px; }
    .card {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .status {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .status:last-child { border-bottom: none; }
    .status-label { color: #888; }
    .status-value { font-weight: bold; color: #00d4ff; font-family: monospace; }
    input[type="password"], input[type="text"] {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 16px;
      margin-bottom: 15px;
    }
    input::placeholder { color: #666; }
    button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 8px;
      background: #00d4ff;
      color: #000;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    button:disabled { background: #444; color: #888; }
    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      background: rgba(255,107,107,0.2);
      color: #ff6b6b;
    }
    .hidden { display: none; }

    /* SUCCESS OVERLAY */
    #success-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #0a5d0a;
      z-index: 9999;
      padding: 20px;
      text-align: center;
      overflow-y: auto;
    }
    #success-overlay.hidden { display: none; }
    .big-icon { font-size: 80px; margin: 20px 0; }
    .big-title { font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 20px; }
    .screenshot-box {
      background: #ff4444;
      color: #fff;
      padding: 15px;
      border-radius: 8px;
      font-size: 20px;
      font-weight: bold;
      margin: 20px 0;
      animation: pulse 1s infinite;
    }
    @keyframes pulse { 50% { transform: scale(1.03); } }
    .url-box {
      background: #000;
      color: #0f0;
      padding: 20px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 16px;
      margin: 20px 0;
      word-break: break-all;
    }
    .info-box {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }
    .info-row { display: flex; justify-content: space-between; margin: 8px 0; }
    .info-label { color: #aaa; }
    .info-val { color: #0ff; font-family: monospace; }
    .instructions {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 8px;
      text-align: left;
      margin-top: 20px;
    }
    .instructions h4 { margin: 0 0 10px 0; color: #0f0; }
    .instructions ol { margin: 0; padding-left: 20px; }
    .instructions li { margin: 8px 0; }
    .fail-section { margin-top: 15px; }
    .fail-section h4 { color: #ff6b6b; }
  </style>
</head>
<body>

<!-- SUCCESS OVERLAY -->
<div id="success-overlay" class="hidden">
  <div class="big-icon">‚è≥</div>
  <div class="big-title">Connecting to WiFi...</div>

  <div class="screenshot-box">üì∏ SCREENSHOT THIS PAGE NOW!</div>

  <div style="color:#aaa;margin-bottom:10px;">Your Dashboard URL:</div>
  <div class="url-box" id="overlay-url">http://beautifi-1.local:5000/dashboard</div>

  <div class="info-box">
    <div class="info-row">
      <span class="info-label">Device ID:</span>
      <span class="info-val" id="overlay-device-id">loading...</span>
    </div>
    <div class="info-row">
      <span class="info-label">Connecting to:</span>
      <span class="info-val" id="overlay-ssid">-</span>
    </div>
  </div>

  <div class="instructions">
    <h4>‚úÖ If connection succeeds:</h4>
    <ol>
      <li>Connect your phone to <strong id="overlay-ssid2">your WiFi</strong></li>
      <li>Open the URL shown above in your browser</li>
      <li>Bookmark it for easy access!</li>
    </ol>

    <div class="fail-section">
      <h4>‚ùå If connection fails (wrong password):</h4>
      <ol>
        <li>The <strong>BeautiFi-Setup</strong> hotspot will reappear</li>
        <li>Reconnect to it and try again</li>
      </ol>
    </div>
  </div>
</div>

<!-- MAIN PAGE -->
<div class="container" id="main-page">
  <h1>BeautiFi Setup</h1>
  <p class="subtitle">Air Quality Monitor</p>

  <div class="card">
    <div class="status">
      <span class="status-label">Device ID</span>
      <span class="status-value" id="device-id">Loading...</span>
    </div>
    <div class="status">
      <span class="status-label">Status</span>
      <span class="status-value" id="conn-status" style="color:#888;">Checking...</span>
    </div>
  </div>

  <div id="message" class="message hidden"></div>

  <div class="card">
    <h3 style="margin-top:0;">Connect to Your WiFi</h3>
    <p style="font-size:13px;color:#888;margin-bottom:15px;">Enter your WiFi network name and password:</p>
    <input type="text" id="ssid-input" placeholder="WiFi Network Name">
    <input type="password" id="password-input" placeholder="WiFi Password">
    <button id="connect-btn" onclick="doConnect()">Connect to WiFi</button>
  </div>
</div>

<script>
var deviceId = 'unknown';
var hostname = 'beautifi-device';

window.onload = function() {
  loadInfo();
};

function loadInfo() {
  fetch('/api/system/status')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.device_id) {
        deviceId = data.device_id;
        document.getElementById('device-id').textContent = deviceId;
      }
      if (data.hostname) {
        hostname = data.hostname;
      }
    })
    .catch(function() {});

  fetch('/api/wifi/status')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.hostname) hostname = data.hostname;
      var statusEl = document.getElementById('conn-status');
      if (data.ap_active) {
        statusEl.textContent = 'Setup Mode';
        statusEl.style.color = '#00d4ff';
      }
    })
    .catch(function() {});
}

function showOverlay(ssid) {
  var url = 'http://' + hostname + '.local:5000/dashboard';
  document.getElementById('overlay-url').textContent = url;
  document.getElementById('overlay-device-id').textContent = deviceId;
  document.getElementById('overlay-ssid').textContent = ssid;
  document.getElementById('overlay-ssid2').textContent = ssid;
  document.getElementById('success-overlay').classList.remove('hidden');
}

function doConnect() {
  var ssid = document.getElementById('ssid-input').value;
  var pw = document.getElementById('password-input').value;

  if (!ssid || !pw) {
    document.getElementById('message').textContent = 'Please enter network name and password';
    document.getElementById('message').classList.remove('hidden');
    return;
  }

  var btn = document.getElementById('connect-btn');
  btn.disabled = true;
  btn.textContent = 'Connecting...';
  document.getElementById('message').classList.add('hidden');

  // Show overlay IMMEDIATELY
  showOverlay(ssid);

  // Send request (don't wait for response)
  fetch('/api/wifi/connect', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ssid: ssid, password: pw})
  }).catch(function() {});
}
</script>
</body>
</html>
